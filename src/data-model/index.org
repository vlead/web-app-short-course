#+TITLE: Data Model for the Mini Version User Directory Application
#+AUTHOR: VLEAD
#+DATE: [2016-05-11 Wed]
#+PROPERTY: results output
#+PROPERTY: exports code
#+SETUPFILE: ../org-templates/level-1.org
#+options: ^:nil
#+LATEX: Literal LaTeX code for export

* Introduction
  The application or the system is abstracted as the data model.  The model
  captures: the entities that comprise the system; relations and constraints
  between these entities; and operations that entail a change in the state of
  the system.


* Notation
  The system is defined as the data model.  There is a certain notation that is
  used defining the data model. 

** Sets, cardinality and relations

If =A= is a set, then
    1. =A!= denotes exactly one element of =A=.
    2. =A?= denotes at most one element of =A=.
    3. =A+= denotes  one or more elements of =A=
    4. =A*=  denotes at zero or more elements of =A=.  Often
       abbreviated as =A=.
    5. =A > B= denotes a relation /from/ =A= /to/ =B=.

** Relations and their cardinality type

A relation =r:A > B= could relate each element of =A= to
zero, one or more elements of =B=.

|--------------------------------+-----------+---+---|
| Cardinality of B               | Notation  |   |   |
|--------------------------------+-----------+---+---|
| at least zero elements of =B=. | r: A > B  |   |   |
|--------------------------------+-----------+---+---|
| at most one element of =B=     | r: A > B? |   |   |
|--------------------------------+-----------+---+---|
| at least one element of =B=    | r: A > B+ |   |   |
|--------------------------------+-----------+---+---|
| exactly one element of =B=     | r: A > B! |   |   |
|--------------------------------+-----------+---+---|
   
** Example of Entity Relationship notation
   This example gives a formal representation of the requirement [[file:~/vlead-projects/bitbucket/web-app-short-course/src/requirements/index.org::#req_user][User]].
#+begin_example
 [email, user] : User? > Email!
#+end_example

Encodes the following items of information:

 - =email= is a relation /from/ the set =User= /to/ the set
   =Email=.

 - =User= is called the /domain/ of the relation =email=.

 - =Email= is called the /codomain/ of the relation =email=.

 - The relation =email= relates each element of =User= to
   /exactly one/ element of =Email=.  This is written as 

 #+begin_example
 email: User > Email!
 #+end_example

 - =user= is a relation /from/ the set =Email= /to/ the set
   =User=.

 - =Email= is called the /domain/ of the relation =user=.

 - =User= is called the /codomain/ of the relation =user=.

 - The relation =user= relates each element of =Email= to
   /at most one/ element of =User=.  This is written as 

 #+begin_example
 user: Email > User?
 #+end_example


* Abstract Entity Types
  The following are the abstract data types in our system. 
** User
:PROPERTIES:
:CUSTOM_ID: entity_user
:END: 
  Requirement satisfied: [[../requirements/index.org::#req_user][User]]

#+BEGIN_SRC spec :tangle spec.txt
;;; Entity Types
TYPE User

#+END_SRC

** Email
:PROPERTIES:
:CUSTOM_ID: entity_email
:END: 
  Requirement satisfied: [[../requirements/index.org::#req_user_identification][Email]]
#+BEGIN_SRC spec :tangle spec.txt
TYPE Email

#+END_SRC

** Name
:PROPERTIES:
:CUSTOM_ID: entity_name
:END: 
  Requirement satisfied: [[../requirements/index.org::#req_user_name][Name]]
#+BEGIN_SRC spec :tangle spec.txt
TYPE Name

#+END_SRC

** Role
:PROPERTIES:
:CUSTOM_ID: entity_role
:END: 
  Requirement satisfied: [[../requirements/index.org::#req_role][Role]]
#+BEGIN_SRC spec :tangle spec.txt
TYPE Role = {admin, user}

#+END_SRC

** Session
:PROPERTIES:
:CUSTOM_ID: entity_session
:END: 
  Requirement satisfied: [[../requirements/index.org::#req_session][Session]]
#+BEGIN_SRC spec :tangle spec.txt
TYPE Session

#+END_SRC


* Relations and cardinality constraints over entity types 
  :PROPERTIES:
  :CUSTOM_ID: cardinal_constraints
  :END: 
  For each relation, we define its inverse next to it.

  Meets requirements [[../requirements/index.org::#req_user_uniqueness][uniqueness of a user]], [[../requirements/index.org::#req_user_role][role of a user]] and [[../requirements/index.org::#req_session_constraints][session constraints]]

#+BEGIN_SRC spec :tangle spec.txt
;;; Relations with cardinality constraints
[email, user]    :  User?    > Email!
[name, users]    :  User     > Name!
[roles, users]   :  User     > Role+
[user, sessions] :  Session  > User!

#+END_SRC


  #+BEGIN_HTML
  <p>   The following diagram summarizes all the cardinality constraints
  across all entities.
  </p>
  <img src="https://docs.google.com/drawings/d/1960E6vwRV9OqUOaUfyOU07btK4hQJLSyZwy1TOPeOF4/pub?w=960&h=720"
  <p align="center"> Entity Diagram </p>
  #+END_HTML

  To edit the image click [[https://docs.google.com/drawings/d/1960E6vwRV9OqUOaUfyOU07btK4hQJLSyZwy1TOPeOF4/edit?usp%3Dsharing][here]].


* Keys

An entity =K= is called a /key for/ an entity =A= if there
is a relation =r: A? > K!=.

|--------+-------|
| Entity | Key   |
|--------+-------|
| User   | Email |
|--------+-------|


* System state
  The system's state is captured by a set of /state variables/.

** Primary Entity sets
:PROPERTIES:
:CUSTOM_ID: user_session_sets
:END:    
   For the purpose of /the application/, we maintain two primary state
   variables.

   user-set meets the requirement [[../requirements/index.org::#req_user_composition][user composition]] and session-set meets the
   requirement [[../requirements/index.org::#req_session_login][mandatory login]]
   
#+BEGIN_SRC spec :tangle spec.txt

;;; Primary state variables
 user-set    : set[User]    ; set of users in the system
 session-set : set[Session] ; set of sessions in the system

#+END_SRC

and five relations

#+BEGIN_SRC spec :tangle spec.txt
;;; Relations
 email:      User > Email!
 name :      User > Name!
 roles:      User > Role+
 user:       Session > User!

#+END_SRC

** Applying relations to sets
#+begin_example
1.role = admin
2.role = user
5.role = user
{1,2,5}.role = {admin, user,user} = {admin, user}

{1,2,5}.succ = {2,3,6}
{1,2,6}.factors = {{1}, {1,2}, {1,2,3,6}}
{1,2,6}.factors.union = {{1}, {1,2}, {1,2,3,6}}.union = {1,2,3,6}
#+end_example

** Derived Entity sets
   
#+BEGIN_SRC spec :tangle spec.txt
;;; Derived Entity sets
 email-set   : set[Email]   = user-set.email        ; set of emails in the system
 name-set    : set[Name]    = user-set.name         ; set of names in the system
 role-set    : set[Role]    = user-set.role         ; set of all roles of all users
 logged-in-user-set : set[User]   = session-set.user   
 logged-in-role-set :  set[Role]  = session-set.role

#+END_SRC

** Referential Integrity Constraints over entity-sets

*** Admin User
:PROPERTIES:
:CUSTOM_ID: admin_user
:END:    
    There is at least one user with the role =admin=.
    This rule meets requirement [[../requirements/index.org::#req_role_admin][user with admin role]].

*** Referential Integrity over primary and derived entity sets
:PROPERTIES:
:CUSTOM_ID: referential_constraints
:END:
   Meets requirements [[../requirements/index.org::#req_user_uniqueness][uniqueness of a user]], [[../requirements/index.org::#req_user_role][role of a user]] and [[../requirements/index.org::#req_session_constraints][session constraints]]

#+BEGIN_SRC spec :tangle spec.txt
;;; Relation variables with Referential Integrity
[email, user]     :  user-set!    > email-set!
[name, users]     :  user-set+    > name-set!    
[roles, users]    :  user-set+    > role-set+
[user, sessions]  :  session-set  > user-set!
[role, session]   :  session-set  > role-set!

#+END_SRC


* Operations 
CRUD operations.  

Each operation is performed on an entity instance or an
entity-set.   The operation may take additional parameters.
It also takes as a  parameter of the credentials of the
actor performing the operation.

 - C  create a user      
 - R  read from a user   
 - U  update a user      
 - D  delete a user      

** Actor
Operations are performed by Actors.  Our application has two
types of actors:  =system= and =session=. 

|--------------------------------------+---------------------+-----------------+--------------------|
| Operation                            | Actor               | Ref.            | Result             |
|                                      | Credentials         | Integrity       |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| addUser(u:User, s:Session)           | s.role=admin        | u:~user-set     | return user or     |
|                                      |                     | s:session-set   | Failure            |
|--------------------------------------+---------------------+-----------------+--------------------|
| showUsers(s: Session)                | s.user.role=admin   | s:session-set   | return user-set or |
|                                      | OR s.user.role=user |                 | Failure            |
|--------------------------------------+---------------------+-----------------+--------------------|
| delUser(u: User, s: Session          | s.user.role=admin   | u:user-set      | return user or     |
|                                      |                     | s:session-set   | Failure            |
|                                      |                     | u.role != admin |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| getUserByEmail(e: Email, s: Session  |                     | s:session-set   | return user        |
|--------------------------------------+---------------------+-----------------+--------------------|
| makeUser(e:Email, n:Name, s:Session  | s.user.role = admin | e:~email-set    |                    |
|                                      |                     | s:session-set   |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| getEmail(u:User,s: Session           |                     | u:user-set      |                    |
|                                      |                     | s:session-set   |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| getName(u: User, s:Session           |                     | u:user-set      |                    |
|                                      |                     | s:session-set   |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| getRole(u: user, s:Session           |                     | u:user-set      |                    |
|                                      |                     | s:session-set   |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| setEmail(u:User, e:Email, s:Session) | s.user.role = admin | u:user-set      |                    |
|                                      | OR s.user = u       | s:session-set   |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| setName(u:User, n:Name, s:)          | s.user.role =admin  | u:user-set      |                    |
|                                      | OR s.user = u       | s:session-set   |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| login(u:User, s:System)              |                     | u:user-set      | creates a session  |
|                                      |                     |                 | and adds it to     |
|                                      |                     |                 | =session-set=      |
|--------------------------------------+---------------------+-----------------+--------------------|
| delSession(s:, s:System)             |                     | es:session-set  |                    |
|--------------------------------------+---------------------+-----------------+--------------------|
| showSessions(s:)                     | s.user.role=admin   |                 |                    |
|--------------------------------------+---------------------+-----------------+--------------------|


** Remarks

- =makeUser(e: Email, n:Name, s: Session)= :: WHen a user is created by an
     admin, that user is assigned the role =user=. 

- =delUser(u:User, s: Session)= ::  Only =admin-user= can delete another user.
     The =admin-user= may not delete him/herself.


